import{Controller as e}from"@hotwired/stimulus";import t from"cable_ready";import{createConsumer as r}from"@rails/actioncable";const l={reflexAttribute:"data-reflex",reflexPermanentAttribute:"data-reflex-permanent",reflexRootAttribute:"data-reflex-root",reflexSuppressLoggingAttribute:"data-reflex-suppress-logging",reflexDatasetAttribute:"data-reflex-dataset",reflexDatasetAllAttribute:"data-reflex-dataset-all",reflexSerializeFormAttribute:"data-reflex-serialize-form",reflexFormSelectorAttribute:"data-reflex-form-selector",reflexIncludeInnerHtmlAttribute:"data-reflex-include-inner-html",reflexIncludeTextContentAttribute:"data-reflex-include-text-content"};let n={};var o={set(e){n={...l,...e.schema};for(const e in n)Object.defineProperty(this,e.slice(0,-9),{get:()=>n[e]})}};let a=!1;var s={get enabled(){return a},get disabled(){return!a},get value(){return a},set(e){a=!!e},set debug(e){a=!!e}};const i={};var d=(e,t,r,l,n,o)=>{const a=i[e];s.disabled||a.promise.data.suppressLogging||(a.timestamp=new Date,console.log(`↑ stimulus ↑ ${t}`,{reflexId:e,args:r,controller:l,element:n,controllerElement:o}))},c=(e,t)=>{const{detail:r}=e||{},{selector:l,payload:n}=r||{},{reflexId:o,target:a,morph:d}=r.stimulusReflex||{},c=i[o];if(s.disabled||c.promise.data.suppressLogging)return;const u=c.totalOperations>1?` ${c.completedOperations}/${c.totalOperations}`:"",f=c.timestamp?`in ${new Date-c.timestamp}ms`:"CLONED",m=e.type.split(":")[1].split("-").slice(1).join("_");console.log(`↓ reflex ↓ ${a} → ${l||"∞"}${u} ${f}`,{reflexId:o,morph:d,operation:m,halted:t,payload:n})},u=e=>{const{detail:t}=e||{},{reflexId:r,target:l,payload:n}=t.stimulusReflex||{},o=i[r];if(s.disabled||o.promise.data.suppressLogging)return;const a=o.timestamp?`in ${new Date-o.timestamp}ms`:"CLONED";console.log(`↓ reflex ↓ ${l} ${a} %cERROR: ${e.detail.body}`,"color: #f00;",{reflexId:r,payload:n})};let f=!0;var m={get enabled(){return f},get disabled(){return!f},get value(){return f},set(e){f=!!e},set deprecate(e){f=!!e}};const p=()=>{const e=window.crypto||window.msCrypto;return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^e.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))},x=(e,t=!0)=>"string"!=typeof e?"":(e=e.replace(/[\s_](.)/g,(e=>e.toUpperCase())).replace(/[\s_]/g,"").replace(/^(.)/,(e=>e.toLowerCase())),t&&(e=e.substr(0,1).toUpperCase()+e.substr(1)),e),h=(e,t)=>{document.dispatchEvent(new CustomEvent(e,{bubbles:!0,cancelable:!1,detail:t})),window.jQuery&&window.jQuery(document).trigger(e,t)},g=e=>{if(""!==e.id)return"//*[@id='"+e.id+"']";if(e===document.body)return"/html/body";let t=0;const r=e?.parentNode?e.parentNode.childNodes:[];for(var l=0;l<r.length;l++){const n=r[l];if(n===e){return`${g(e.parentNode)}/${e.tagName.toLowerCase()}[${t+1}]`}1===n.nodeType&&n.tagName===e.tagName&&t++}},b=e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,y=(e,t=!1)=>{const r=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let e=0;e<r.snapshotLength;e++)l.push(r.snapshotItem(e));return t?l.reverse():l},v=(e=[])=>{const t=e.filter((e=>e&&String(e).length)).map((e=>e.trim())).join(" ").trim();return t.length?t:null},E=e=>e&&e.length?e.split(" ").filter((e=>e.trim().length)):[],w=e=>{let t=Array.from(e.attributes).reduce(((e,t)=>(e[t.name]=t.value,e)),{});if(t.checked=!!e.checked,t.selected=!!e.selected,t.tag_name=e.tagName,e.tagName.match(/select/i)||(e=>!!["checkbox","radio"].includes(e.type)&&document.querySelectorAll(`input[type="${e.type}"][name="${e.name}"]`).length>1)(e)){const r=(e=>Array.from(e.querySelectorAll("option:checked")).concat(Array.from(document.querySelectorAll(`input[type="${e.type}"][name="${e.name}"]`)).filter((e=>e.checked))).map((e=>e.value)))(e);t.values=r,t.value=r.join(",")}else t.value=e.value;return t},C=(e,t)=>{if(!t||0===t.length)return[];let r=[e];const l=g(e);return t.forEach((e=>{try{switch(e){case"combined":m.enabled&&console.warn("In the next version of StimulusReflex, the 'combined' option to data-reflex-dataset will become 'ancestors'."),r=[...r,...y(`${l}/ancestor::*`,!0)];break;case"ancestors":r=[...r,...y(`${l}/ancestor::*`,!0)];break;case"parent":r=[...r,...y(`${l}/parent::*`)];break;case"siblings":r=[...r,...y(`${l}/preceding-sibling::*|${l}/following-sibling::*`)];break;case"children":r=[...r,...y(`${l}/child::*`)];break;case"descendants":r=[...r,...y(`${l}/descendant::*`)];break;default:r=[...r,...document.querySelectorAll(e)]}}catch(e){s.enabled&&console.error(e)}})),r},I=e=>{let t={};return e&&e.attributes&&Array.from(e.attributes).forEach((e=>{e.name.startsWith("data-")&&(t[e.name]=e.value)})),t};let R=!1;var S={get disabled(){return!R},set(e){R=e}};const A=(e,t,r,l,n)=>{if(!r||!r.reflexData[l])return;const o=r.reflexController[l],a=r.reflexData[l].target,s=a.split("#")[1],d=o[["before","after","finalize"].includes(e)?`${e}${x(s)}`:`${x(s,!1)}${x(e)}`],c=o[["before","after","finalize"].includes(e)?`${e}Reflex`:`reflex${x(e)}`];"function"==typeof d&&d.call(o,t,a,r.reflexError[l],l,n),"function"==typeof c&&c.call(o,t,a,r.reflexError[l],l,n),i[l]&&e===i[l].finalStage&&(Reflect.deleteProperty(r.reflexController,l),Reflect.deleteProperty(r.reflexData,l),Reflect.deleteProperty(r.reflexError,l))};document.addEventListener("stimulus-reflex:before",(e=>A("before",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)),!0),document.addEventListener("stimulus-reflex:success",(e=>{A("success",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload),$("after",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)}),!0),document.addEventListener("stimulus-reflex:nothing",(e=>{$("success",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)}),!0),document.addEventListener("stimulus-reflex:error",(e=>{A("error",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload),$("after",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)}),!0),document.addEventListener("stimulus-reflex:halted",(e=>A("halted",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)),!0),document.addEventListener("stimulus-reflex:after",(e=>A("after",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)),!0),document.addEventListener("stimulus-reflex:finalize",(e=>A("finalize",e.detail.element,e.detail.controller.element,e.detail.reflexId,e.detail.payload)),!0);const $=(e,t,r,l,n)=>{if(!r)return void(s.enabled&&!i[l].warned&&(console.warn(`StimulusReflex was not able execute callbacks or emit events for "${e}" or later life-cycle stages for this Reflex. The StimulusReflex Controller Element is no longer present in the DOM. Could you move the StimulusReflex Controller to an element higher in your DOM?`),i[l].warned=!0));if(!r.reflexController||r.reflexController&&!r.reflexController[l])return void(s.enabled&&!i[l].warned&&(console.warn(`StimulusReflex detected that the StimulusReflex Controller responsible for this Reflex has been replaced with a new instance. Callbacks and events for "${e}" or later life-cycle stages cannot be executed.`),i[l].warned=!0));const{target:o}=r.reflexData[l]||{},a=r.reflexController[l]||{},d=`stimulus-reflex:${e}`,c=`${d}:${o.split("#")[1]}`,u={reflex:o,controller:a,reflexId:l,element:t,payload:n},f={bubbles:!0,cancelable:!1,detail:u};r.dispatchEvent(new CustomEvent(d,f)),r.dispatchEvent(new CustomEvent(c,f)),window.jQuery&&(window.jQuery(r).trigger(d,u),window.jQuery(r).trigger(c,u))},L=(e,t)=>E(t.getAttribute(o.controller)).reduce(((r,l)=>{const n=e.getControllerForElementAndIdentifier(t,l);return n&&n.StimulusReflex&&r.push(n),r}),[]),O=e=>{if(!e.cableReady)return;if(e.version.replace(".pre","-pre")!==t.version)return void(s.enabled&&console.error(`Reflex failed due to cable_ready gem/NPM package version mismatch. Package versions must match exactly.\nNote that if you are using pre-release builds, gems use the "x.y.z.preN" version format, while NPM packages use "x.y.z-preN".\n\ncable_ready gem: ${e.version}\ncable_ready NPM: ${t.version}`));let r,l=[];for(let t=e.operations.length-1;t>=0;t--)e.operations[t].stimulusReflex&&(l.push(e.operations[t]),e.operations.splice(t,1));if(!l.some((e=>e.stimulusReflex.url!==location.href)))if(l.length&&(r=l[0].stimulusReflex,r.payload=l[0].payload),r){const{reflexId:n,payload:o}=r;if(!i[n]&&S.disabled){const e=b(r.xpathController),t=b(r.xpathElement);e.reflexController=e.reflexController||{},e.reflexData=e.reflexData||{},e.reflexError=e.reflexError||{},e.reflexController[n]=i.app.getControllerForElementAndIdentifier(e,r.reflexController),e.reflexData[n]=r,$("before",t,e,n,o),_(r)}i[n]&&(i[n].totalOperations=l.length,i[n].pendingOperations=l.length,i[n].completedOperations=0,i[n].piggybackOperations=e.operations,t.perform(l))}else e.operations.length&&i[e.operations[0].reflexId]&&t.perform(e.operations)},_=e=>{const{reflexId:t}=e;i[t]={finalStage:"finalize"};const r=new Promise(((r,l)=>{i[t].promise={resolve:r,reject:l,data:e}}));return r.reflexId=t,s.enabled&&r.catch((()=>{})),r},D=((e,t=250)=>{let r;return(...l)=>{clearTimeout(r),r=setTimeout((()=>{r=null,e(...l)}),t)}})((()=>{document.querySelectorAll(`[${o.reflex}]`).forEach((e=>{const t=E(e.getAttribute(o.controller)),r=E(e.getAttribute(o.reflex)),l=E(e.getAttribute(o.action));r.forEach((r=>{const n=((e,t)=>t.find((t=>{if(t.identifier)return(e=>{const t=e.match(/(?:.*->)?(.*?)(?:Reflex)?#/);return t?t[1]:""})(e).replace(/([a-z0–9])([A-Z])/g,"$1-$2").replace(/(::)/g,"--").toLowerCase()===t.identifier}))||t[0])(r,((e,t)=>{let r=[];for(;t;)r=r.concat(L(e,t)),t=t.parentElement;return r})(i.app,e));let o;n?(o=`${r.split("->")[0]}->${n.identifier}#__perform`,l.includes(o)||l.push(o)):(o=`${r.split("->")[0]}->stimulus-reflex#__perform`,t.includes("stimulus-reflex")||t.push("stimulus-reflex"),l.includes(o)||l.push(o))}));const n=v(t),a=v(l);n&&e.getAttribute(o.controller)!=n&&e.setAttribute(o.controller,n),a&&e.getAttribute(o.action)!=a&&e.setAttribute(o.action,a)})),h("stimulus-reflex:ready")}),20);class T{constructor(e,t,r,l,n,o,a,s,i){this.options=e,this.reflexElement=t,this.controllerElement=r,this.reflexController=l,this.permanentAttributeName=n,this.target=o,this.args=a,this.url=s,this.tabId=i}get attrs(){return this._attrs=this._attrs||this.options.attrs||w(this.reflexElement),this._attrs}get reflexId(){return this._reflexId=this._reflexId||this.options.reflexId||p(),this._reflexId}get selectors(){return this._selectors=this._selectors||this.options.selectors||(e=>{let t=[];for(;0===t.length&&e;){let r=e.getAttribute(o.reflexRoot);if(r){0===r.length&&e.id&&(r=`#${e.id}`);const l=r.split(",").filter((e=>e.trim().length));s.enabled&&0===l.length&&console.error(`No value found for ${o.reflexRoot}. Add an #id to the element or provide a value for ${o.reflexRoot}.`,e),t=t.concat(l.filter((e=>document.querySelector(e))))}e=e.parentElement?e.parentElement.closest(`[${o.reflexRoot}]`):null}return t})(this.reflexElement),"string"==typeof this._selectors?[this._selectors]:this._selectors}get resolveLate(){return this.options.resolveLate||!1}get dataset(){return this._dataset=this._dataset||(e=>{const t=e.attributes[o.reflexDataset],r=e.attributes[o.reflexDatasetAll],l=t&&t.value.split(" ")||[],n=r&&r.value.split(" ")||[],a=C(e,l),s=C(e,n),i=a.reduce(((e,t)=>({...I(t),...e})),{}),d={dataset:{...I(e),...i},datasetAll:{}};return s.forEach((e=>{const t=I(e);Object.keys(t).forEach((e=>{const r=t[e];d.datasetAll[e]&&Array.isArray(d.datasetAll[e])?d.datasetAll[e].push(r):d.datasetAll[e]=[r]}))})),d})(this.reflexElement),this._dataset}get innerHTML(){return this.includeInnerHtml?this.reflexElement.innerHTML:""}get textContent(){return this.includeTextContent?this.reflexElement.textContent:""}get xpathController(){return g(this.controllerElement)}get xpathElement(){return g(this.reflexElement)}get formSelector(){const e=this.reflexElement.attributes[o.reflexFormSelector]?this.reflexElement.attributes[o.reflexFormSelector].value:void 0;return this.options.formSelector||e}get includeInnerHtml(){const e=this.reflexElement.attributes[o.reflexIncludeInnerHtml]||!1;return!(!this.options.includeInnerHTML&&!e)&&"false"!==e.value}get includeTextContent(){const e=this.reflexElement.attributes[o.reflexIncludeTextContent]||!1;return!(!this.options.includeTextContent&&!e)&&"false"!==e.value}get suppressLogging(){return this.options.suppressLogging||this.reflexElement.attributes[o.reflexSuppressLogging]||!1}valueOf(){return{attrs:this.attrs,dataset:this.dataset,selectors:this.selectors,reflexId:this.reflexId,resolveLate:this.resolveLate,suppressLogging:this.suppressLogging,xpathController:this.xpathController,xpathElement:this.xpathElement,inner_html:this.innerHTML,text_content:this.textContent,formSelector:this.formSelector,reflexController:this.reflexController,permanentAttributeName:this.permanentAttributeName,target:this.target,args:this.args,url:this.url,tabId:this.tabId,version:"3.5.0-pre9"}}}let N,j,k;const z=()=>{k=!0,document.body.classList.replace("stimulus-reflex-disconnected","stimulus-reflex-connected"),h("stimulus-reflex:connected"),h("stimulus-reflex:action-cable:connected")},P=()=>{k=!1,document.body.classList.replace("stimulus-reflex-connected","stimulus-reflex-disconnected"),h("stimulus-reflex:rejected"),h("stimulus-reflex:action-cable:rejected"),Debug.enabled&&console.warn("Channel subscription was rejected.")},F=e=>{k=!1,document.body.classList.replace("stimulus-reflex-connected","stimulus-reflex-disconnected"),h("stimulus-reflex:disconnected",e),h("stimulus-reflex:action-cable:disconnected",e)};var M={consumer:N,params:j,get subscriptionActive(){return k},createSubscription:e=>{N=N||e.application.consumer||r();const{channel:t}=e.StimulusReflex,l={channel:t,...j},n=JSON.stringify(l);e.StimulusReflex.subscription=N.subscriptions.findAll(n)[0]||N.subscriptions.create(l,{received:O,connected:z,rejected:P,disconnected:F})},connected:z,rejected:P,disconnected:F,set(e,t){N=e,j=t}};const H=e=>{const{stimulusReflex:t,payload:r}=e.detail||{};if(!t)return;const{reflexId:l,xpathElement:n,xpathController:o}=t,a=b(o),s=b(n),d=i[l],{promise:c}=d;d.pendingOperations--,d.pendingOperations>0||(t.resolveLate||setTimeout((()=>c.resolve({element:s,event:e,data:c.data,payload:r,reflexId:l,toString:()=>""}))),setTimeout((()=>$("success",s,a,l,r))))},U=e=>{const{stimulusReflex:r,payload:l}=e.detail||{};if(!r)return;const{reflexId:n,xpathElement:o,xpathController:a}=r,s=b(a),d=b(o),u=i[n],{promise:f}=u;u.completedOperations++,c(e,!1),u.completedOperations<u.totalOperations||(r.resolveLate&&setTimeout((()=>f.resolve({element:d,event:e,data:f.data,payload:l,reflexId:n,toString:()=>""}))),setTimeout((()=>$("finalize",d,s,n,l))),u.piggybackOperations.length&&t.perform(u.piggybackOperations))},q=(e,t,r,l,n)=>{l.finalStage="after",c(e,!1),setTimeout((()=>r.resolve({data:r.data,element:n,event:e,payload:t,reflexId:r.data.reflexId,toString:()=>""})))},Q=(e,t,r,l,n)=>{l.finalStage="halted",c(e,!0),setTimeout((()=>r.resolve({data:r.data,element:n,event:e,payload:t,reflexId:r.data.reflexId,toString:()=>""})))},V=(e,t,r,l,n)=>{l.finalStage="after",u(e),setTimeout((()=>r.reject({data:r.data,element:n,event:e,payload:t,reflexId:r.data.reflexId,error:e.detail.body,toString:()=>e.detail.body})))};class X extends e{constructor(...e){super(...e),J(this)}}const Y=(e,{controller:t,consumer:r,debug:l,params:n,isolate:a,deprecate:d}={})=>{M.set(r,n),document.addEventListener("DOMContentLoaded",(()=>{document.body.classList.remove("stimulus-reflex-connected"),document.body.classList.add("stimulus-reflex-disconnected"),m.enabled&&r&&console.warn("Deprecation warning: the next version of StimulusReflex will obtain a reference to consumer via the Stimulus application object.\nPlease add 'application.consumer = consumer' to your index.js after your Stimulus application has been established, and remove the consumer key from your StimulusReflex initialize() options object."),m.enabled&&S.disabled&&console.warn("Deprecation warning: the next version of StimulusReflex will standardize isolation mode, and the isolate option will be removed.\nPlease update your applications to assume that every tab will be isolated.")}),{once:!0}),S.set(!!a),i.app=e,o.set(e),i.app.register("stimulus-reflex",t||X),s.set(!!l),void 0!==d&&m.set(d);new MutationObserver(D).observe(document.documentElement,{attributeFilter:[o.reflex,o.action],childList:!0,subtree:!0})},J=(e,t={})=>{e.StimulusReflex={...t,channel:"StimulusReflex::Channel"},M.createSubscription(e),Object.assign(e,{isActionCableConnectionOpen(){return this.StimulusReflex.subscription.consumer.connection.isOpen()},stimulate(){const e=location.href,t=Array.from(arguments),r=t.shift()||"StimulusReflex::Reflex#default_reflex",l=this.element,n=t[0]&&t[0].nodeType===Node.ELEMENT_NODE?t.shift():l;if("number"===n.type&&n.validity&&n.validity.badInput)return void(s.enabled&&console.warn("Reflex aborted: invalid numeric input"));const a={};if(t[0]&&"object"==typeof t[0]&&Object.keys(t[0]).filter((e=>["attrs","selectors","reflexId","resolveLate","serializeForm","suppressLogging","includeInnerHTML","includeTextContent"].includes(e))).length){const e=t.shift();Object.keys(e).forEach((t=>a[t]=e[t]))}const i=new T(a,n,l,this.identifier,o.reflexPermanent,r,t,e,W),c=i.reflexId;if(!this.isActionCableConnectionOpen())throw"The ActionCable connection is not open! `this.isActionCableConnectionOpen()` must return true before calling `this.stimulate()`";if(!M.subscriptionActive)throw"The ActionCable channel subscription for StimulusReflex was rejected.";l.reflexController=l.reflexController||{},l.reflexData=l.reflexData||{},l.reflexError=l.reflexError||{},l.reflexController[c]=this,l.reflexData[c]=i.valueOf(),$("before",n,l,c),setTimeout((()=>{const{params:e}=l.reflexData[c]||{},t=n.attributes[o.reflexSerializeForm];t&&(a.serializeForm="false"!==t.value);const r=n.closest(i.formSelector)||document.querySelector(i.formSelector)||n.closest("form");m.enabled&&void 0===a.serializeForm&&r&&console.warn(`Deprecation warning: the next version of StimulusReflex will not serialize forms by default.\nPlease set ${o.reflexSerializeForm}="true" on your Reflex Controller Element or pass { serializeForm: true } as an option to stimulate.`);const s=!1===a.serializeForm?"":((e,t={})=>{if(!e)return"";const r=t.w||window,{element:l}=t,n=new r.FormData(e),o=Array.from(n,(e=>e.map(encodeURIComponent).join("="))),a=e.querySelector("input[type=submit]");return l&&l.name&&"INPUT"===l.nodeName&&"submit"===l.type?o.push(`${encodeURIComponent(l.name)}=${encodeURIComponent(l.value)}`):a&&a.name&&o.push(`${encodeURIComponent(a.name)}=${encodeURIComponent(a.value)}`),Array.from(o).join("&")})(r,{element:n});l.reflexData[c]={...i.valueOf(),params:e,formData:s},this.StimulusReflex.subscription.send(l.reflexData[c])}));const u=_(i.valueOf());return d(c,r,t,this.context.scope.identifier,n,l),u},__perform(e){let t,r=e.target;for(;r&&!t;)t=r.getAttribute(o.reflex),t&&t.trim().length||(r=r.parentElement);const l=E(t).find((t=>t.split("->")[0]===e.type));l&&(e.preventDefault(),e.stopPropagation(),this.stimulate(l.split("->")[1],r))}})},W=p(),Z=(e,t={})=>{J(e,t)};document.addEventListener("cable-ready:after-dispatch-event",(e=>{const{stimulusReflex:r,payload:l,name:n,body:o}=e.detail||{},a=n.split("-")[2];if(!r||!["nothing","halted","error"].includes(a))return;const{reflexId:s,xpathElement:d,xpathController:c}=r,u=b(d),f=b(c),m=i[s],{promise:p}=m;switch(f&&(f.reflexError=f.reflexError||{},"error"===a&&(f.reflexError[s]=o)),a){case"nothing":q(e,l,p,m,u);break;case"error":V(e,l,p,m,u);break;case"halted":Q(e,l,p,m,u)}setTimeout((()=>$(a,u,f,s,l))),m.piggybackOperations.length&&t.perform(m.piggybackOperations)})),document.addEventListener("cable-ready:before-inner-html",H),document.addEventListener("cable-ready:before-morph",H),document.addEventListener("cable-ready:after-inner-html",U),document.addEventListener("cable-ready:after-morph",U),window.addEventListener("load",D);const B={...Object.freeze({__proto__:null,initialize:Y,register:J,useReflex:Z}),get debug(){return s.value},set debug(e){s.set(!!e)},get deprecate(){return m.value},set deprecate(e){m.set(!!e)}};window.StimulusReflex=B;export{B as default,Y as initialize,J as register,Z as useReflex};
//# sourceMappingURL=stimulus_reflex.min.js.map
