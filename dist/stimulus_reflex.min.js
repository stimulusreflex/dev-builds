import{Controller as e}from"@hotwired/stimulus";import t,{Utils as o}from"cable_ready";import{createConsumer as r}from"@rails/actioncable";
/*!
 * Toastify js 1.12.0
 * https://github.com/apvarun/toastify-js
 * @license MIT licensed
 *
 * Copyright (C) 2018 Varun A P
 */class n{defaults={oldestFirst:!0,text:"Toastify is awesome!",node:void 0,duration:3e3,selector:void 0,callback:function(){},destination:void 0,newWindow:!1,close:!1,gravity:"toastify-top",positionLeft:!1,position:"",backgroundColor:"",avatar:"",className:"",stopOnFocus:!0,onClick:function(){},offset:{x:0,y:0},escapeMarkup:!0,ariaLive:"polite",style:{background:""}};constructor(e){this.version="1.12.0",this.options={},this.toastElement=null,this._rootElement=document.body,this._init(e)}showToast(){if(this.toastElement=this._buildToast(),"string"==typeof this.options.selector?this._rootElement=document.getElementById(this.options.selector):this.options.selector instanceof HTMLElement||this.options.selector instanceof ShadowRoot?this._rootElement=this.options.selector:this._rootElement=document.body,!this._rootElement)throw"Root element is not defined";return this._rootElement.insertBefore(this.toastElement,this._rootElement.firstChild),this._reposition(),this.options.duration>0&&(this.toastElement.timeOutValue=window.setTimeout((()=>{this._removeElement(this.toastElement)}),this.options.duration)),this}hideToast(){this.toastElement.timeOutValue&&clearTimeout(this.toastElement.timeOutValue),this._removeElement(this.toastElement)}_init(e){this.options=Object.assign(this.defaults,e),this.options.backgroundColor&&console.warn('DEPRECATION NOTICE: "backgroundColor" is being deprecated. Please use the "style.background" property.'),this.toastElement=null,this.options.gravity="bottom"===e.gravity?"toastify-bottom":"toastify-top",this.options.stopOnFocus=void 0===e.stopOnFocus||e.stopOnFocus,e.backgroundColor&&(this.options.style.background=e.backgroundColor)}_buildToast(){if(!this.options)throw"Toastify is not initialized";let e=document.createElement("div");e.className=`toastify on ${this.options.className}`,e.className+=` toastify-${this.options.position}`,e.className+=` ${this.options.gravity}`;for(const t in this.options.style)e.style[t]=this.options.style[t];if(this.options.ariaLive&&e.setAttribute("aria-live",this.options.ariaLive),this.options.node&&this.options.node.nodeType===Node.ELEMENT_NODE)e.appendChild(this.options.node);else if(this.options.escapeMarkup?e.innerText=this.options.text:e.innerHTML=this.options.text,""!==this.options.avatar){let t=document.createElement("img");t.src=this.options.avatar,t.className="toastify-avatar","left"==this.options.position?e.appendChild(t):e.insertAdjacentElement("afterbegin",t)}if(!0===this.options.close){let t=document.createElement("button");t.type="button",t.setAttribute("aria-label","Close"),t.className="toast-close",t.innerHTML="&#10006;",t.addEventListener("click",(e=>{e.stopPropagation(),this._removeElement(this.toastElement),window.clearTimeout(this.toastElement.timeOutValue)}));const o=window.innerWidth>0?window.innerWidth:screen.width;"left"==this.options.position&&o>360?e.insertAdjacentElement("afterbegin",t):e.appendChild(t)}if(this.options.stopOnFocus&&this.options.duration>0&&(e.addEventListener("mouseover",(t=>{window.clearTimeout(e.timeOutValue)})),e.addEventListener("mouseleave",(()=>{e.timeOutValue=window.setTimeout((()=>{this._removeElement(e)}),this.options.duration)}))),void 0!==this.options.destination&&e.addEventListener("click",(e=>{e.stopPropagation(),!0===this.options.newWindow?window.open(this.options.destination,"_blank"):window.location=this.options.destination})),"function"==typeof this.options.onClick&&void 0===this.options.destination&&e.addEventListener("click",(e=>{e.stopPropagation(),this.options.onClick()})),"object"==typeof this.options.offset){const t=this._getAxisOffsetAValue("x",this.options),o=this._getAxisOffsetAValue("y",this.options),r="left"==this.options.position?t:`-${t}`,n="toastify-top"==this.options.gravity?o:`-${o}`;e.style.transform=`translate(${r},${n})`}return e}_removeElement(e){e.className=e.className.replace(" on",""),window.setTimeout((()=>{this.options.node&&this.options.node.parentNode&&this.options.node.parentNode.removeChild(this.options.node),e.parentNode&&e.parentNode.removeChild(e),this.options.callback.call(e),this._reposition()}),400)}_reposition(){let e,t={top:15,bottom:15},o={top:15,bottom:15},r={top:15,bottom:15},n=this._rootElement.querySelectorAll(".toastify");for(let i=0;i<n.length;i++){e=!0===n[i].classList.contains("toastify-top")?"toastify-top":"toastify-bottom";let s=n[i].offsetHeight;e=e.substr(9,e.length-1);let l=15;(window.innerWidth>0?window.innerWidth:screen.width)<=360?(n[i].style[e]=`${r[e]}px`,r[e]+=s+l):!0===n[i].classList.contains("toastify-left")?(n[i].style[e]=`${t[e]}px`,t[e]+=s+l):(n[i].style[e]=`${o[e]}px`,o[e]+=s+l)}}_getAxisOffsetAValue(e,t){return t.offset[e]?isNaN(t.offset[e])?t.offset[e]:`${t.offset[e]}px`:"0px"}}function i(){const e="stimulus-reflex-toast-element";let t=document.querySelector(`#${e}`);if(!t){t=document.createElement("div"),t.id=e,document.documentElement.appendChild(t);const o=document.createElement("style");o.innerHTML=`\n      #${e} .toastify {\n         padding: 12px 20px;\n         color: #ffffff;\n         display: inline-block;\n         background: -webkit-linear-gradient(315deg, #73a5ff, #5477f5);\n         background: linear-gradient(135deg, #73a5ff, #5477f5);\n         position: fixed;\n         opacity: 0;\n         transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);\n         border-radius: 2px;\n         cursor: pointer;\n         text-decoration: none;\n         max-width: calc(50% - 20px);\n         z-index: 2147483647;\n         bottom: -150px;\n         right: 15px;\n      }\n\n      #${e} .toastify.on {\n        opacity: 1;\n      }\n\n      #${e} .toast-close {\n        background: transparent;\n        border: 0;\n        color: white;\n        cursor: pointer;\n        font-family: inherit;\n        font-size: 1em;\n        opacity: 0.4;\n        padding: 0 5px;\n      }\n    `,document.head.appendChild(o)}return t}t.operations.stimulusReflexVersionMismatch=e=>{const t={selector:i(),close:!0,duration:3e4,gravity:"bottom",position:"right",newWindow:!0,style:{info:{},success:{background:"#198754",color:"white"},warn:{background:"#ffc107",color:"black"},error:{background:"#dc3545",color:"white"}}[e.level||"info"]};var o;(o={...t,...e},new n(o)).showToast()};let s=!0;var l={get enabled(){return s},get disabled(){return!s},get value(){return s},set(e){s=!!e},set deprecate(e){s=!!e}};let a=!1;var d={get enabled(){return a},get disabled(){return!a},get value(){return a},set(e){a=!!e},set debug(e){a=!!e}};const c={reflexAttribute:"data-reflex",reflexPermanentAttribute:"data-reflex-permanent",reflexRootAttribute:"data-reflex-root",reflexSuppressLoggingAttribute:"data-reflex-suppress-logging",reflexDatasetAttribute:"data-reflex-dataset",reflexDatasetAllAttribute:"data-reflex-dataset-all",reflexSerializeFormAttribute:"data-reflex-serialize-form",reflexFormSelectorAttribute:"data-reflex-form-selector",reflexIncludeInnerHtmlAttribute:"data-reflex-include-inner-html",reflexIncludeTextContentAttribute:"data-reflex-include-text-content"};let u={};var p={set(e){u={...c,...e.schema};for(const e in u){const t=e.slice(0,-9);Object.defineProperty(this,t,{get:()=>u[e],configurable:!0})}}};const{debounce:m,dispatch:f,xpathToElement:h,xpathToElementArray:g}=o,b=()=>{const e=window.crypto||window.msCrypto;return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^e.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))},x=(e,t=!0)=>"string"!=typeof e?"":(e=e.replace(/[\s_](.)/g,(e=>e.toUpperCase())).replace(/[\s_]/g,"").replace(/^(.)/,(e=>e.toLowerCase())),t&&(e=e.substr(0,1).toUpperCase()+e.substr(1)),e),y=h,v=g,E=(e,t={})=>f(document,e,t),w=e=>{if(""!==e.id)return"//*[@id='"+e.id+"']";if(e===document.body)return"/html/body";if("HTML"===e.nodeName)return"/html";let t=0;const o=e&&e.parentNode?e.parentNode.childNodes:[];for(var r=0;r<o.length;r++){const n=o[r];if(n===e){return`${w(e.parentNode)}/${e.tagName.toLowerCase()}[${t+1}]`}1===n.nodeType&&n.tagName===e.tagName&&t++}},L=["created","before","delivered","queued","after","finalized","success","error","halted","forbidden"];let $;const C=new Proxy({},{get:function(e,t){return L.includes(t)?Object.fromEntries(Object.entries(e).filter((([e,o])=>o.stage===t))):"last"===t?$:"all"===t?e:Reflect.get(...arguments)},set:function(e,t,o){return e[t]=o,$=o,!0}}),A=(e,t)=>{const o=e.controller[["before","after","finalize"].includes(t)?`${t}${x(e.action)}`:`${x(e.action,!1)}${x(t)}`],r=e.controller[["before","after","finalize"].includes(t)?`${t}Reflex`:`reflex${x(t)}`];"function"==typeof o&&o.call(e.controller,e.element,e.target,e.error,e.id,e.payload),"function"==typeof r&&r.call(e.controller,e.element,e.target,e.error,e.id,e.payload)},O=(e,t)=>{if(!e.controller.element.parentElement)return void(d.enabled&&!e.warned&&(console.warn(`StimulusReflex was not able execute callbacks or emit events for "${t}" or later life-cycle stages for this Reflex. The StimulusReflex Controller Element is no longer present in the DOM. Could you move the StimulusReflex Controller to an element higher in your DOM?`),e.warned=!0));e.stage=t,e.lifecycle.push(t);const o=`stimulus-reflex:${t}`,r=`${o}:${e.action}`,n={reflex:e.target,controller:e.controller,id:e.id,element:e.element,payload:e.payload},i={bubbles:!0,cancelable:!1,detail:n};e.controller.element.dispatchEvent(new CustomEvent(o,i)),e.controller.element.dispatchEvent(new CustomEvent(r,i)),window.jQuery&&(window.jQuery(e.controller.element).trigger(o,n),window.jQuery(e.controller.element).trigger(r,n))};document.addEventListener("stimulus-reflex:before",(e=>A(C[e.detail.id],"before")),!0),document.addEventListener("stimulus-reflex:queued",(e=>A(C[e.detail.id],"queued")),!0),document.addEventListener("stimulus-reflex:delivered",(e=>A(C[e.detail.id],"delivered")),!0),document.addEventListener("stimulus-reflex:success",(e=>{const t=C[e.detail.id];A(t,"success"),O(t,"after")}),!0),document.addEventListener("stimulus-reflex:nothing",(e=>O(C[e.detail.id],"success")),!0),document.addEventListener("stimulus-reflex:error",(e=>{const t=C[e.detail.id];A(t,"error"),O(t,"after")}),!0),document.addEventListener("stimulus-reflex:halted",(e=>A(C[e.detail.id],"halted")),!0),document.addEventListener("stimulus-reflex:forbidden",(e=>A(C[e.detail.id],"forbidden")),!0),document.addEventListener("stimulus-reflex:after",(e=>A(C[e.detail.id],"after")),!0),document.addEventListener("stimulus-reflex:finalize",(e=>A(C[e.detail.id],"finalize")),!0);let _={};var R={get app(){return _},set(e){_=e}};let k=!1;var S={get disabled(){return!k},set(e){k=e,l.enabled&&!k&&document.addEventListener("DOMContentLoaded",(()=>console.warn("Deprecation warning: the next version of StimulusReflex will standardize isolation mode, and the isolate option will be removed.\nPlease update your applications to assume that every tab will be isolated. Use CableReady operations to broadcast updates to other tabs and users.")),{once:!0})}};class T{constructor(e,t){this.data=e.valueOf(),this.controller=t,this.element=e.reflexElement,this.id=e.id,this.error=null,this.payload=null,this.stage="created",this.lifecycle=["created"],this.warned=!1,this.target=e.target,this.action=e.target.split("#")[1],this.selector=null,this.morph=null,this.operation=null,this.timestamp=new Date,this.cloned=!1}get getPromise(){const e=new Promise(((e,t)=>{this.promise={resolve:e,reject:t,data:this.data}}));return e.id=this.id,Object.defineProperty(e,"reflexId",{get(){return l.enabled&&console.warn("reflexId is deprecated and will be removed from v4. Use id instead."),this.id}}),e.reflex=this,d.enabled&&e.catch((()=>{})),e}}const N=e=>{if(!e.cableReady)return;if(e.version.replace(".pre","-pre")!==t.version)return void(d.enabled&&console.error(`Reflex failed due to cable_ready gem/NPM package version mismatch. Package versions must match exactly.\nNote that if you are using pre-release builds, gems use the "x.y.z.preN" version format, while NPM packages use "x.y.z-preN".\n\ncable_ready gem: ${e.version}\ncable_ready NPM: ${t.version}`));let o,r=[];for(let t=e.operations.length-1;t>=0;t--)e.operations[t].stimulusReflex&&(r.push(e.operations[t]),e.operations.splice(t,1));if(r.some((e=>e.stimulusReflex.url!==location.href))&&d.enabled)console.error("Reflex failed due to mismatched URL.");else if(r.length&&(o=r[0].stimulusReflex,o.payload=r[0].payload),o){const{id:n,payload:i}=o;let s;if(!C[n]&&S.disabled){const e=y(o.xpathController),t=y(o.xpathElement);e.reflexController=e.reflexController||{},e.reflexData=e.reflexData||{},e.reflexError=e.reflexError||{};const r=R.app.getControllerForElementAndIdentifier(e,o.reflexController);e.reflexController[n]=r,e.reflexData[n]=o,s=new T(o,r),C[n]=s,s.cloned=!0,s.element=t,r.lastReflex=s,O(s,"before"),s.getPromise}else s=C[n];s&&(s.payload=i,s.totalOperations=r.length,s.pendingOperations=r.length,s.completedOperations=0,s.piggybackOperations=e.operations,t.perform(r))}else e.operations.length&&C[e.operations[0].reflexId]&&t.perform(e.operations)};let j,I,D,z;const F=()=>{z=!0,H(),E("stimulus-reflex:connected"),Object.values(C.queued).forEach((e=>{D.send(e.data),O(e,"delivered")}))},P=()=>{z=!1,H(),E("stimulus-reflex:rejected"),Debug.enabled&&console.warn("Channel subscription was rejected.")},M=e=>{z=!1,H(),E("stimulus-reflex:disconnected",e)},H=()=>{const e=document.body.classList;e.contains("stimulus-reflex-connected")||e.contains("stimulus-reflex-disconnected")?z?e.replace("stimulus-reflex-disconnected","stimulus-reflex-connected"):e.replace("stimulus-reflex-connected","stimulus-reflex-disconnected"):e.add(z?"stimulus-reflex-connected":"stimulus-reflex-disconnected")};var q={subscribe:e=>{if(D)return;j=j||e.application.consumer||r();const{channel:t}=e.StimulusReflex,o={channel:t,...I},n=JSON.stringify(o);D=j.subscriptions.findAll(n)[0]||j.subscriptions.create(o,{received:N,connected:F,rejected:P,disconnected:M})},deliver:e=>{z?(D.send(e.data),O(e,"delivered")):O(e,"queued")},initialize:(e,t)=>{j=e,I=t,document.addEventListener("DOMContentLoaded",(()=>{z=!1,H(),l.enabled&&e&&console.warn("Deprecation warning: the next version of StimulusReflex will obtain a reference to consumer via the Stimulus application object.\nPlease add 'application.consumer = consumer' to your index.js after your Stimulus application has been established, and remove the consumer key from your StimulusReflex initialize() options object.")})),document.addEventListener("turbolinks:load",H),document.addEventListener("turbo:load",H)}};const U=e=>e.cloned?"CLONED":`in ${new Date-e.timestamp}ms`,V=e=>e.totalOperations>1?` ${e.completedOperations}/${e.totalOperations}`:"";var W=e=>{d.disabled||e.data.suppressLogging||console.log(`↑ stimulus ↑ ${e.target}`,{id:e.id,args:e.data.args,controller:e.controller.identifier,element:e.element,controllerElement:e.controller.element})},B=e=>{if(d.disabled||e.data.suppressLogging)return;const t={id:e.id,morph:e.morph,payload:e.payload};"dispatch_event"!==e.operation&&(t.operation=e.operation),console.log(`↓ reflex ↓ ${e.target} → ${e.selector||"∞"}${V(e)} ${U(e)}`,t)},Q=e=>{d.disabled||e.data.suppressLogging||console.log(`↓ reflex ↓ ${e.target} ${U(e)} %cHALTED`,"color: #ffa500;",{id:e.id,payload:e.payload})},J=e=>{d.disabled||e.data.suppressLogging||console.log(`↓ reflex ↓ ${e.target} ${U(e)} %cFORBIDDEN`,"color: #BF40BF;",{id:e.id,payload:e.payload})},Z=e=>{d.disabled||e.data.suppressLogging||console.log(`↓ reflex ↓ ${e.target} ${U(e)} %cERROR: ${e.error}`,"color: #f00;",{id:e.id,payload:e.payload})};const G=(e=[])=>{const t=Array.from(new Set(e.filter((e=>e&&String(e).length)).map((e=>e.trim())))).join(" ").trim();return t.length>0?t:null},K=e=>e&&e.length?e.split(" ").filter((e=>e.trim().length)):[],X=e=>{let t=Array.from(e.attributes).reduce(((e,t)=>(e[t.name]=t.value,e)),{});if(t.checked=!!e.checked,t.selected=!!e.selected,t.tag_name=e.tagName,e.tagName.match(/select/i)||(e=>!!["checkbox","radio"].includes(e.type)&&document.querySelectorAll(`input[type="${e.type}"][name="${e.name}"]`).length>1)(e)){const o=(e=>Array.from(e.querySelectorAll("option:checked")).concat(Array.from(document.querySelectorAll(`input[type="${e.type}"][name="${e.name}"]`)).filter((e=>e.checked))).map((e=>e.value)))(e);t.values=o,t.value=o.join(",")}else t.value=e.value;return t},Y=(e,t)=>{if(!t||0===t.length)return[];let o=[e];const r=w(e);return t.forEach((e=>{try{switch(e){case"combined":l.enabled&&console.warn("In the next version of StimulusReflex, the 'combined' option to data-reflex-dataset will become 'ancestors'."),o=[...o,...v(`${r}/ancestor::*`,!0)];break;case"ancestors":o=[...o,...v(`${r}/ancestor::*`,!0)];break;case"parent":o=[...o,...v(`${r}/parent::*`)];break;case"siblings":o=[...o,...v(`${r}/preceding-sibling::*|${r}/following-sibling::*`)];break;case"children":o=[...o,...v(`${r}/child::*`)];break;case"descendants":o=[...o,...v(`${r}/descendant::*`)];break;default:o=[...o,...document.querySelectorAll(e)]}}catch(e){d.enabled&&console.error(e)}})),o},ee=e=>{let t={};return e&&e.attributes&&Array.from(e.attributes).forEach((e=>{e.name.startsWith("data-")&&(t[e.name]=e.value)})),t};var te="3.5.0-pre10";class oe{constructor(e,t,o,r,n,i,s,l,a){this.options=e,this.reflexElement=t,this.controllerElement=o,this.reflexController=r,this.permanentAttributeName=n,this.target=i,this.args=s,this.url=l,this.tabId=a}get attrs(){return this._attrs=this._attrs||this.options.attrs||X(this.reflexElement),this._attrs}get id(){return this._id=this._id||this.options.id||b(),this._id}get selectors(){return this._selectors=this._selectors||this.options.selectors||(e=>{let t=[];for(;0===t.length&&e;){let o=e.getAttribute(p.reflexRoot);if(o){0===o.length&&e.id&&(o=`#${e.id}`);const r=o.split(",").filter((e=>e.trim().length));d.enabled&&0===r.length&&console.error(`No value found for ${p.reflexRoot}. Add an #id to the element or provide a value for ${p.reflexRoot}.`,e),t=t.concat(r.filter((e=>document.querySelector(e))))}e=e.parentElement?e.parentElement.closest(`[${p.reflexRoot}]`):null}return t})(this.reflexElement),"string"==typeof this._selectors?[this._selectors]:this._selectors}get resolveLate(){return this.options.resolveLate||!1}get dataset(){return this._dataset=this._dataset||(e=>{const t=e.attributes[p.reflexDataset],o=e.attributes[p.reflexDatasetAll],r=t&&t.value.split(" ")||[],n=o&&o.value.split(" ")||[],i=Y(e,r),s=Y(e,n),l=i.reduce(((e,t)=>({...ee(t),...e})),{}),a={dataset:{...ee(e),...l},datasetAll:{}};return s.forEach((e=>{const t=ee(e);Object.keys(t).forEach((e=>{const o=t[e];a.datasetAll[e]&&Array.isArray(a.datasetAll[e])?a.datasetAll[e].push(o):a.datasetAll[e]=[o]}))})),a})(this.reflexElement),this._dataset}get innerHTML(){return this.includeInnerHtml?this.reflexElement.innerHTML:""}get textContent(){return this.includeTextContent?this.reflexElement.textContent:""}get xpathController(){return w(this.controllerElement)}get xpathElement(){return w(this.reflexElement)}get formSelector(){const e=this.reflexElement.attributes[p.reflexFormSelector]?this.reflexElement.attributes[p.reflexFormSelector].value:void 0;return this.options.formSelector||e}get includeInnerHtml(){const e=this.reflexElement.attributes[p.reflexIncludeInnerHtml]||!1;return!(!this.options.includeInnerHTML&&!e)&&"false"!==e.value}get includeTextContent(){const e=this.reflexElement.attributes[p.reflexIncludeTextContent]||!1;return!(!this.options.includeTextContent&&!e)&&"false"!==e.value}get suppressLogging(){return this.options.suppressLogging||this.reflexElement.attributes[p.reflexSuppressLogging]||!1}valueOf(){return{attrs:this.attrs,dataset:this.dataset,selectors:this.selectors,id:this.id,resolveLate:this.resolveLate,suppressLogging:this.suppressLogging,xpathController:this.xpathController,xpathElement:this.xpathElement,inner_html:this.innerHTML,text_content:this.textContent,formSelector:this.formSelector,reflexController:this.reflexController,permanentAttributeName:this.permanentAttributeName,target:this.target,args:this.args,url:this.url,tabId:this.tabId,version:te}}}let re={};var ne={get plugin(){return re},set(e){re=e}};const ie=e=>{const{stimulusReflex:t}=e.detail||{};if(!t)return;const o=C[t.id];o.pendingOperations--,o.pendingOperations>0||(t.resolveLate||setTimeout((()=>o.promise.resolve({element:o.element,event:e,data:o.data,payload:o.payload,id:o.id,toString:()=>""}))),setTimeout((()=>O(o,"success"))))},se=e=>{const{stimulusReflex:o}=e.detail||{};if(!o)return;const r=C[o.id];r.completedOperations++,r.selector=e.detail.selector,r.morph=e.detail.stimulusReflex.morph,r.operation=e.type.split(":")[1].split("-").slice(1).join("_"),B(r),r.completedOperations<r.totalOperations||(o.resolveLate&&setTimeout((()=>r.promise.resolve({element:r.element,event:e,data:r.data,payload:r.payload,id:r.id,toString:()=>""}))),setTimeout((()=>O(r,"finalize"))),r.piggybackOperations.length&&t.perform(r.piggybackOperations))},le=(e,t)=>{B(e),setTimeout((()=>e.promise.resolve({data:e.data,element:e.element,event:t,payload:e.payload,id:e.id,toString:()=>""})))},ae=(e,t)=>{Q(e,t),setTimeout((()=>e.promise.resolve({data:e.data,element:e.element,event:t,payload:e.payload,id:e.id,toString:()=>""})))},de=(e,t)=>{J(e,t),setTimeout((()=>e.promise.resolve({data:e.data,element:e.element,event:t,payload:e.payload,id:e.id,toString:()=>""})))},ce=(e,t)=>{Z(e,t),setTimeout((()=>e.promise.reject({data:e.data,element:e.element,event:t,payload:e.payload,id:e.id,error:e.error,toString:()=>e.error})))},ue=e=>K(e.getAttribute(p.controller)).reduce(((t,o)=>{const r=R.app.getControllerForElementAndIdentifier(e,o);return r&&r.StimulusReflex&&t.push(r),t}),[]),pe=m((()=>{document.querySelectorAll(`[${p.reflex}]`).forEach((e=>me(e)))}),20),me=e=>{const t=e.getAttribute(p.controller),o=K(t),r=e.getAttribute(p.reflex),n=K(r),i=e.getAttribute(p.action),s=K(i).filter((e=>!e.includes("#__perform")));n.forEach((t=>{const r=((e,t)=>t.find((t=>{if(t.identifier)return(e=>{const t=e.match(/(?:.*->)?(.*?)(?:Reflex)?#/);return t?t[1]:""})(e).replace(/([a-z0–9])([A-Z])/g,"$1-$2").replace(/(::)/g,"--").toLowerCase()===t.identifier}))||t[0])(t,(e=>{let t=[];for(;e;)t=t.concat(ue(e)),e=e.parentElement;return t})(e)),n=r?r.identifier:"stimulus-reflex";s.push(`${t.split("->")[0]}->${n}#__perform`),o.push(n)}));const l=G(o),a=G(s);let d=!1;l&&e.getAttribute(p.controller)!=l&&(e.setAttribute(p.controller,l),d=!0),a&&e.getAttribute(p.action)!=a&&(e.setAttribute(p.action,a),d=!0),d&&f(e,"stimulus-reflex:ready",{reflex:r,controller:l,action:a,element:e})};class fe extends e{constructor(...e){super(...e),be(this)}}const he=b(),ge=(e,{controller:t,consumer:o,debug:r,params:n,isolate:i,deprecate:s,transport:a}={})=>{ne.set(a||q),ne.plugin.initialize(o,n),S.set(!!i),R.set(e),p.set(e),R.app.register("stimulus-reflex",t||fe),d.set(!!r),void 0!==s&&l.set(s);new MutationObserver(pe).observe(document.documentElement,{attributeFilter:[p.reflex,p.action],childList:!0,subtree:!0}),E("stimulus-reflex:initialized")},be=(e,t={})=>{e.StimulusReflex={...t,channel:"StimulusReflex::Channel"},ne.plugin.subscribe(e),Object.assign(e,{stimulate(){const e=location.href,t=this.element,o=Array.from(arguments),r=o.shift()||"StimulusReflex::Reflex#default_reflex",n=((e,t)=>e[0]&&e[0].nodeType===Node.ELEMENT_NODE?e.shift():t)(o,t);if("number"===(i=n).type&&i.validity&&i.validity.badInput)return void(d.enabled&&console.warn("Reflex aborted: invalid numeric input"));var i;const s=(e=>{const t={};if(e[0]&&"object"==typeof e[0]&&Object.keys(e[0]).filter((e=>["id","attrs","selectors","reflexId","resolveLate","serializeForm","suppressLogging","includeInnerHTML","includeTextContent"].includes(e))).length){const o=e.shift();Object.keys(o).forEach((e=>{"reflexId"===e?(l.enabled&&console.warn("reflexId option will be removed in v4. Use id instead."),t.id=o.reflexId):t[e]=o[e]}))}return t})(o),a=new oe(s,n,t,this.identifier,p.reflexPermanent,r,o,e,he),c=a.id;t.reflexController=t.reflexController||{},t.reflexData=t.reflexData||{},t.reflexError=t.reflexError||{},t.reflexController[c]=this,t.reflexData[c]=a.valueOf();const u=new T(a,this);return C[c]=u,this.lastReflex=u,O(u,"before"),setTimeout((()=>{const{params:e}=t.reflexData[c]||{},o=n.attributes[p.reflexSerializeForm];o&&(s.serializeForm="false"!==o.value);const r=n.closest(a.formSelector)||document.querySelector(a.formSelector)||n.closest("form");l.enabled&&void 0===s.serializeForm&&r&&console.warn(`Deprecation warning: the next version of StimulusReflex will not serialize forms by default.\nPlease set ${p.reflexSerializeForm}="true" on your Reflex Controller Element or pass { serializeForm: true } as an option to stimulate.`);const i=!1===s.serializeForm?"":((e,t={})=>{if(!e)return"";const o=t.w||window,{element:r}=t,n=new o.FormData(e),i=Array.from(n,(e=>e.map(encodeURIComponent).join("="))),s=e.querySelector("input[type=submit]");return r&&r.name&&"INPUT"===r.nodeName&&"submit"===r.type?i.push(`${encodeURIComponent(r.name)}=${encodeURIComponent(r.value)}`):s&&s.name&&i.push(`${encodeURIComponent(s.name)}=${encodeURIComponent(s.value)}`),Array.from(i).join("&")})(r,{element:n});u.data={...a.valueOf(),params:e,formData:i},t.reflexData[c]=u.data,ne.plugin.deliver(u)})),W(u),u.getPromise},__perform(e){let t,o=e.target;for(;o&&!t;)t=o.getAttribute(p.reflex),t&&t.trim().length||(o=o.parentElement);const r=K(t).find((t=>t.split("->")[0]===e.type));r&&(e.preventDefault(),e.stopPropagation(),this.stimulate(r.split("->")[1],o))}}),e.reflexes||Object.defineProperty(e,"reflexes",{get(){return new Proxy(C,{get:function(e,t){return"last"===t?this.lastReflex:Object.fromEntries(Object.entries(e[t]).filter((([e,t])=>t.controller===this)))}.bind(this)})}}),me(e.element),E("stimulus-reflex:controller-registered",{detail:{controller:e}})},xe=(e,t={})=>{be(e,t)};document.addEventListener("cable-ready:after-dispatch-event",(e=>{const{stimulusReflex:o,name:r}=e.detail||{},n=r.split("-")[2],i={nothing:le,halted:ae,forbidden:de,error:ce};if(!o||!Object.keys(i).includes(n))return;const s=C[o.id];s.completedOperations++,s.pendingOperations--,s.selector=e.detail.selector,s.morph=e.detail.stimulusReflex.morph,s.operation=e.type.split(":")[1].split("-").slice(1).join("_"),"error"===n&&(s.error=e.detail.error),i[n](s,e),setTimeout((()=>O(s,n))),s.piggybackOperations.length&&t.perform(s.piggybackOperations)})),document.addEventListener("cable-ready:before-inner-html",ie),document.addEventListener("cable-ready:before-morph",ie),document.addEventListener("cable-ready:after-inner-html",se),document.addEventListener("cable-ready:after-morph",se),document.addEventListener("readystatechange",(()=>{"complete"===document.readyState&&pe()}));const ye={version:te,...Object.freeze({__proto__:null,initialize:ge,reflexes:C,register:be,scanForReflexes:pe,scanForReflexesOnElement:me,useReflex:xe}),get debug(){return d.value},set debug(e){d.set(!!e)},get deprecate(){return l.value},set deprecate(e){l.set(!!e)}};window.StimulusReflex=ye;export{ye as default,ge as initialize,C as reflexes,be as register,pe as scanForReflexes,me as scanForReflexesOnElement,xe as useReflex};
//# sourceMappingURL=stimulus_reflex.min.js.map
